"use strict";var __assign=this&&this.__assign||Object.assign||function(e){for(var t,r=1,n=arguments.length;r<n;r++)for(var o in t=arguments[r])Object.prototype.hasOwnProperty.call(t,o)&&(e[o]=t[o]);return e},__awaiter=this&&this.__awaiter||function(i,s,a,u){return new(a||(a=Promise))(function(e,t){function r(e){try{o(u.next(e))}catch(e){t(e)}}function n(e){try{o(u.throw(e))}catch(e){t(e)}}function o(t){t.done?e(t.value):new a(function(e){e(t.value)}).then(r,n)}o((u=u.apply(i,s||[])).next())})},__generator=this&&this.__generator||function(r,n){var o,i,s,e,a={label:0,sent:function(){if(1&s[0])throw s[1];return s[1]},trys:[],ops:[]};return e={next:t(0),throw:t(1),return:t(2)},"function"==typeof Symbol&&(e[Symbol.iterator]=function(){return this}),e;function t(t){return function(e){return function(t){if(o)throw new TypeError("Generator is already executing.");for(;a;)try{if(o=1,i&&(s=2&t[0]?i.return:t[0]?i.throw||((s=i.return)&&s.call(i),0):i.next)&&!(s=s.call(i,t[1])).done)return s;switch(i=0,s&&(t=[2&t[0],s.value]),t[0]){case 0:case 1:s=t;break;case 4:return a.label++,{value:t[1],done:!1};case 5:a.label++,i=t[1],t=[0];continue;case 7:t=a.ops.pop(),a.trys.pop();continue;default:if(!(s=0<(s=a.trys).length&&s[s.length-1])&&(6===t[0]||2===t[0])){a=0;continue}if(3===t[0]&&(!s||t[1]>s[0]&&t[1]<s[3])){a.label=t[1];break}if(6===t[0]&&a.label<s[1]){a.label=s[1],s=t;break}if(s&&a.label<s[2]){a.label=s[2],a.ops.push(t);break}s[2]&&a.ops.pop(),a.trys.pop();continue}t=n.call(r,a)}catch(e){t=[6,e],i=0}finally{o=s=0}if(5&t[0])throw t[1];return{value:t[0]?t[1]:void 0,done:!0}}([t,e])}}};Object.defineProperty(exports,"__esModule",{value:!0});var amqp=require("amqplib"),RabbitMqInterface=function(){function e(){this.debug=!1,this.connectionUri="amqp://localhost",this.offlineQueue=[],this.logger("[Rabbitode] is ready to use")}return e.prototype.setRabbitUri=function(e){return this.connectionUri=e,this},e.prototype.enableDebugging=function(){return this.debug=!0,this},e.prototype.disableDebugging=function(){return this.debug=!1,this},e.prototype.startRabbit=function(){return amqp.connect(this.connectionUri)},e.prototype.publishToExchange=function(e,i,s){var a=e.exchangeName,u=e.routingKey,c=e.content;return void 0===s&&(s={exchange:{durable:!1},channel:{persistent:!0}}),__awaiter(this,void 0,void 0,function(){var t,r,n,o;return __generator(this,function(e){switch(e.label){case 0:return e.trys.push([0,7,,8]),[4,this.startRabbit()];case 1:t=e.sent(),this.logger("[Rabbitode] creating channel"),e.label=2;case 2:return e.trys.push([2,5,,6]),[4,t.createConfirmChannel()];case 3:return[4,(r=e.sent()).assertExchange(a,i,__assign({},s.exchange))];case 4:return e.sent(),this.sendPublishMessage(r,s,a,u,c,i),this.afterPublish(r,t),[3,6];case 5:return n=e.sent(),this.logger("[Rabbitode] channel error "+n,"error"),this.handlePublishError(n,a,u,this.bufferIfy(c),i),[3,6];case 6:return[3,8];case 7:return o=e.sent(),this.logger("[Rabbitode] channel error "+o,"error"),this.handlePublishError(o,a,u,this.bufferIfy(c),i),[3,8];case 8:return[2]}})})},e.prototype.sendDirect=function(e,t){return this.publishToExchange(e,"direct",t),this},e.prototype.sendFanout=function(e,t){return this.publishToExchange(e,"fanout",t),this},e.prototype.sendTopic=function(e,t){return this.publishToExchange(e,"topic",t),this},e.prototype.sendPublishMessage=function(r,n,o,i,s,a){return __awaiter(this,void 0,void 0,function(){var t;return __generator(this,function(e){switch(e.label){case 0:return this.logger("[Rabbitode] publishing message"),t=this.bufferIfy(s),[4,r.publish(o,i,t,__assign({},n.channel),this.publisherCallback(o,i,t,a))];case 1:return e.sent(),[2]}})})},e.prototype.publisherCallback=function(t,r,n,o){var i=this;return function(e){e&&i.handlePublishError(e,t,r,n,o),i.logger("[Rabbitode] message sent")}},e.prototype.afterPublish=function(t,r){var e=this;setTimeout(function(){return __awaiter(e,void 0,void 0,function(){return __generator(this,function(e){switch(e.label){case 0:return this.logger("[Rabbitode] closing channel"),[4,t.close()];case 1:return e.sent(),this.logger("[Rabbitode] closing connection"),[4,r.close()];case 2:return e.sent(),[2]}})})},2500)},e.prototype.handlePublishError=function(e,t,r,n,o){this.logger("[Rabbitode] there was a problem "+e,"error"),this.offlineQueue.push({exchangeType:o,message:{exchangeName:t,routingKey:r,formattedContent:n},isPublished:!1})},e.prototype.startConsumer=function(e,s,a){var t=e.exchangeName,u=void 0===t?"":t,r=e.exchangeType,c=void 0===r?"direct":r,n=e.queueName,h=void 0===n?"":n,l=e.consumerCallback;return void 0===s&&(s={exchange:{durable:!1},queue:{exclusive:!1},consumer:{noAck:!1}}),void 0===a&&(a=[]),__awaiter(this,void 0,void 0,function(){var t,r,n,o,i;return __generator(this,function(e){switch(e.label){case 0:return e.trys.push([0,14,,15]),[4,this.startRabbit()];case 1:t=e.sent(),e.label=2;case 2:return e.trys.push([2,12,,13]),[4,t.createChannel()];case 3:return r=e.sent(),this.logger("[Rabbitode] asserting exchange"),[4,r.assertExchange(u,c,__assign({},s.exchange))];case 4:return e.sent(),this.logger("[Rabbitode] asserting queue"),[4,r.assertQueue(h,__assign({},s.queue))];case 5:return n=e.sent(),0<a.length?(this.logger("[Rabbitode] binding topics to queue"),[4,this.mapTopics(r,n.queue,u,a)]):[3,7];case 6:return e.sent(),[3,9];case 7:return this.logger("[Rabbitode] binding queue to exchange"),[4,r.bindQueue(n.queue,u,n.queue)];case 8:e.sent(),e.label=9;case 9:return this.logger("[Rabbitode] prefetching"),[4,r.prefetch(10)];case 10:return e.sent(),this.logger("[Rabbitode] consuming messages"),[4,r.consume(n.queue,l(r),__assign({},s.consumer))];case 11:return e.sent(),this.logger("[Rabbitode] waiting on more messages"),[3,13];case 12:return o=e.sent(),this.logger("[Rabbitode] consumer channel error "+o,"error"),[3,13];case 13:return[3,15];case 14:return i=e.sent(),this.logger("[Rabbitode] consumer connection error "+i,"error"),[3,15];case 15:return[2]}})})},e.prototype.mapTopics=function(r,n,o,t){var i=this;return new Promise(function(e){e(t.map(function(t){return __awaiter(i,void 0,void 0,function(){return __generator(this,function(e){switch(e.label){case 0:return[4,r.bindQueue(n,o,t)];case 1:return[2,e.sent()]}})})}))})},e.prototype.startDirectConsumer=function(e,t){return this.startConsumer(__assign({},e,{exchangeType:"direct"}),t),this},e.prototype.startFanoutConsumer=function(e,t){return this.startConsumer(__assign({},e,{exchangeType:"fanout"}),t),this},e.prototype.startTopicConsumer=function(e,t,r){return this.startConsumer(__assign({},e,{exchangeType:"topic"}),r,t),this},e.prototype.bufferIfy=function(e){var t=e;return"string"!=typeof t&&"object"==typeof t&&(t=JSON.stringify(e)),Buffer.from(t)},e.prototype.handleRabbitErrror=function(e){"Connection closing"!==e.message&&this.logger("[Rabbitode] conn error "+e.message,e.message)},e.prototype.handleRabbitClose=function(){var e=this;this.logger("[Rabbitode] Restarting","warn"),setTimeout(function(){return __awaiter(e,void 0,void 0,function(){return __generator(this,function(e){return[2,this.startRabbit()]})})},1e3)},e.prototype.isJsonString=function(e){try{JSON.parse(e)}catch(e){return!1}return!0},e.prototype.decodeToString=function(e){return e.content.toString()},e.prototype.decodeToJson=function(e){if(this.isJsonString(e.content.toString()))return JSON.parse(e.content.toString());this.logger("[Rabbitode] message is not valid json","error")},e.prototype.logger=function(e,t){if(void 0===t&&(t="log"),this.debug)switch(t){case"warning":console.warn(e);break;case"info":console.info(e);break;case"error":console.error(e);break;default:console.log(e)}},e}();exports.RabbitMqInterface=RabbitMqInterface,module.exports.RabbitMqInterface=RabbitMqInterface;